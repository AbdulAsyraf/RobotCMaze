#pragma config(Sensor, S1,     eyesIR,         sensorEV3_IRSensor)
#pragma config(Sensor, S3,     eyes,           sensorEV3_Ultrasonic)
#pragma config(Sensor, S4,     gyro,           sensorEV3_Gyro)
#pragma config(Motor,  motorA,          right,         tmotorEV3_Large, PIDControl, driveRight, encoder)
#pragma config(Motor,  motorB,          head,          tmotorEV3_Medium, PIDControl, encoder)
#pragma config(Motor,  motorD,          left,          tmotorEV3_Large, PIDControl, driveLeft, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

int Tp = 40;
int options[3] = {0, 0, 0};
//pusing -1 for left 1 for right

void depan(float masa){
	resetTimer(T1);
	while(getTimer(T1, seconds) < masa){
		setMotorSpeed(left, Tp);
		setMotorSpeed(right, Tp);
	}
	stopAllMotors();
	wait1Msec(250);
}

//pusing -1 for left 1 for right
void pusing(int where){

	resetGyro(gyro);
	wait1Msec(500);
	if(where != 0){
		while(abs(getGyroDegrees(gyro)) < 80){
			setMotorSpeed(left, -Tp/2 * where);
			setMotorSpeed(right, Tp/2 * where);
		}

		setMotorSpeed(left, -5 * where);
		setMotorSpeed(right, 5 * where);
		wait1Msec(250);
	}
	stopAllMotors();

}

void depanSampai(float gapUS, float gapIR){

	depan(3);

	while (getUSDistance(eyes)<=(2 * gapUS) && getIRDistance(eyesIR) > gapIR){
		setMotorSpeed(left, Tp);
		setMotorSpeed(right, Tp);
	}
	depan(1.5);
	stopAllMotors();
	wait1Msec(250);
}

void tengok(float gapIR){
	float scans[3];
	//static int options[3] = {0, 0, 0};
	//options[0] left
	//options[1] forward
	//options[2] right

	setMotorTarget(head, -90, 10);
	waitUntilMotorStop(head);
	scans[0] = getIRDistance(eyesIR);
	wait1Msec(250);

	setMotorTarget(head, 0, 10);
	waitUntilMotorStop(head);
	scans[1] = getIRDistance(eyesIR);
	wait1Msec(250);

	setMotorTarget(head, 90, 10);
	waitUntilMotorStop(head);
	scans[2] = getIRDistance(eyesIR);
	wait1Msec(250);

	setMotorTarget(head, 0, 10);
	waitUntilMotorStop(head);
	wait1Msec(250);

	float gap = gapIR + (gapIR/2);
	if (gap > 100){
		gap = 100;
	}

	for (int i = 0; i < 3; i++){
		if(scans[i] > gapIR){
			options[i] = 1;
		}
	}
}

void decide(){
	if (options[0] == 1)
		pusing(-1);
	else if(options[1] == 1)
		pusing(0);
	else if(options[2] == 1)
		pusing(1);
	else{
		pusing(-1);
		pusing(-1);
	}
}

task main(){

	//int * i;
	//int f[3];

	float gapUS = getUSDistance(eyes);
	setMotorTarget(head, -90, 10);
	waitUntilMotorStop(head);
	float gapIR = getIRDistance(eyesIR);
	wait1Msec(250);
	setMotorTarget(head, 0, 10);
	waitUntilMotorStop(head);
	wait1Msec(250);

	for (int rep = 0; rep < 5; rep++){
		depanSampai(gapUS, gapIR);
		tengok(gapIR);
		decide();
	}

	wait1Msec(2000);
}
